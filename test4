--// Full Vertical UI Framework (Drag + Close + Minimize + Icons) [FIXED]

local Library = {}
Library.__index = Library

Library.Gui = nil
Library.Visible = true
Library.Minimized = false

--// Services
local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")

--// Utility
local function create(class, props)
    local obj = Instance.new(class)
    for k, v in pairs(props or {}) do
        obj[k] = v
    end
    return obj
end

--// Icon Mapping
Library.Icons = {
    rewind = "rbxassetid://4483362458",
    play   = "rbxassetid://4483362458",
    pause  = "rbxassetid://4483362458",
    close  = "rbxassetid://4483362458",
    minus  = "rbxassetid://4483362458",
}

--// Visibility
function Library:SetVisibility(state)
    self.Visible = state
    if self.Gui then
        self.Gui.Enabled = state
    end
end

function Library:IsVisible()
    return self.Visible
end

function Library:Destroy()
    if self.Gui then
        self.Gui:Destroy()
        self.Gui = nil
    end
end

--// Create Window
function Library:CreateWindow()
    local Window = {}
    Window.__index = Window
    setmetatable(Window, Window)

    -- ScreenGui
    local gui = create("ScreenGui", {
        Name = "FullFrameworkUI",
        ResetOnSpawn = false,
        Parent = Players.LocalPlayer:WaitForChild("PlayerGui")
    })
    Library.Gui = gui

    -- Main Frame
    local main = create("Frame", {
        Size = UDim2.new(0, 456, 0, 440),
        Position = UDim2.new(0.100000001, 416, 0.100000001, 152),
        AnchorPoint = Vector2.new(0.5, 0.5),
        BackgroundColor3 = Color3.fromRGB(25, 25, 25),
        BorderSizePixel = 0,
        Parent = gui
    })

    create("UICorner", { CornerRadius = UDim.new(0, 10), Parent = main })

    -- Top Bar
    local topBar = create("Frame", {
        Size = UDim2.new(1, 0, 0, 36),
        BackgroundColor3 = Color3.fromRGB(30, 30, 30),
        BorderSizePixel = 0,
        Parent = main
    })

    create("UICorner", { CornerRadius = UDim.new(0, 10), Parent = topBar })

    create("TextLabel", {
        Text = "Framework",
        Size = UDim2.new(1, -80, 1, 0),
        Position = UDim2.new(0, 12, 0, 0),
        BackgroundTransparency = 1,
        TextColor3 = Color3.new(1,1,1),
        Font = Enum.Font.GothamBold,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = topBar
    })

    -- Minimize Button
    local minimize = create("TextButton", {
        Size = UDim2.fromOffset(28, 28),
        Position = UDim2.new(1, -64, 0.5, 0),
        AnchorPoint = Vector2.new(0, 0.5),
        Text = "–",
        Font = Enum.Font.GothamBold,
        TextSize = 18,
        BackgroundColor3 = Color3.fromRGB(40, 40, 40),
        TextColor3 = Color3.new(1,1,1),
        BorderSizePixel = 0,
        Parent = topBar
    })
    create("UICorner", { CornerRadius = UDim.new(0, 6), Parent = minimize })

    -- Close Button
    local close = create("TextButton", {
        Size = UDim2.fromOffset(28, 28),
        Position = UDim2.new(1, -32, 0.5, 0),
        AnchorPoint = Vector2.new(0, 0.5),
        Text = "×",
        Font = Enum.Font.GothamBold,
        TextSize = 18,
        BackgroundColor3 = Color3.fromRGB(180, 60, 60),
        TextColor3 = Color3.new(1,1,1),
        BorderSizePixel = 0,
        Parent = topBar
    })
    create("UICorner", { CornerRadius = UDim.new(0, 6), Parent = close })

    -- Content
    local content = create("Frame", {
        Size = UDim2.new(1, -16, 1, -52),
        Position = UDim2.new(0, 8, 0, 44),
        BackgroundTransparency = 1,
        Parent = main
    })

    local layout = create("UIListLayout", {
        Padding = UDim.new(0, 8),
        Parent = content
    })

    layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        content.CanvasSize = UDim2.new(0,0,0,layout.AbsoluteContentSize.Y)
    end)

    -- Dragging (FIXED)
    do
        local dragging = false
        local dragStart, startPos

        topBar.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = true
                dragStart = input.Position
                startPos = main.Position
            end
        end)

        UIS.InputChanged:Connect(function(input)
            if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                local delta = input.Position - dragStart
                main.Position = UDim2.new(
                    startPos.X.Scale,
                    startPos.X.Offset + delta.X,
                    startPos.Y.Scale,
                    startPos.Y.Offset + delta.Y
                )
            end
        end)

        UIS.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = false
            end
        end)
    end

    -- Minimize (FIXED)
    minimize.MouseButton1Click:Connect(function()
        Library.Minimized = not Library.Minimized
        content.Visible = not Library.Minimized
    end)

    -- Close
    close.MouseButton1Click:Connect(function()
        Library:Destroy()
    end)

    -- Tabs
    function Window:CreateTab(name)
        local Tab = {}
        Tab.__index = Tab
        setmetatable(Tab, Tab)

        local tabFrame = create("Frame", {
            Size = UDim2.new(1, 0, 0, 0),
            BackgroundTransparency = 1,
            Parent = content
        })

        local tabLayout = create("UIListLayout", {
            Padding = UDim.new(0, 6),
            Parent = tabFrame
        })

        tabLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
            tabFrame.Size = UDim2.new(1, 0, 0, tabLayout.AbsoluteContentSize.Y)
        end)

        create("TextLabel", {
            Text = name,
            Size = UDim2.new(1, 0, 0, 26),
            BackgroundTransparency = 1,
            TextColor3 = Color3.new(1,1,1),
            Font = Enum.Font.GothamBold,
            TextSize = 14,
            TextXAlignment = Enum.TextXAlignment.Left,
            Parent = tabFrame
        })

        -- Icon Button (FIXED RETURN)
        function Tab:CreateIconButton(text, icon, callback)
            local button = create("TextButton", {
                Size = UDim2.new(1, 0, 0, 34),
                BackgroundColor3 = Color3.fromRGB(35, 35, 35),
                Text = "",
                BorderSizePixel = 0,
                Parent = tabFrame
            })

            create("UICorner", { CornerRadius = UDim.new(0, 8), Parent = button })

            create("ImageLabel", {
                Size = UDim2.fromOffset(18, 18),
                Position = UDim2.new(0, 8, 0.5, 0),
                AnchorPoint = Vector2.new(0, 0.5),
                BackgroundTransparency = 1,
                Image = Library.Icons[icon] or "",
                Parent = button
            })

            local label = create("TextLabel", {
                Text = text,
                Size = UDim2.new(1, -36, 1, 0),
                Position = UDim2.new(0, 36, 0, 0),
                BackgroundTransparency = 1,
                TextColor3 = Color3.fromRGB(230, 230, 230),
                Font = Enum.Font.Gotham,
                TextSize = 13,
                TextXAlignment = Enum.TextXAlignment.Left,
                Parent = button
            })

            if callback then
                button.MouseButton1Click:Connect(callback)
            end

            return {
                Button = button,
                Label = label,
                SetText = function(_, txt)
                    label.Text = txt
                end
            }
        end

        return Tab
    end

    return Window
end

return Library
